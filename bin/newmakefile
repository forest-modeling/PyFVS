
# note: that assumption is that if OS is defined, then then we are 32 bit windows
# other wise, we are Linix and 64 bit. Those are the only two systems
# supported right now.

ifdef OS
 ODBC = odbc32
 ifeq (${as.shared},1)
  SHARED = -shared 
  OUTSUFX = .so
  MAIN = 0
  PIC = 
 else
  SHARED = -static
  OUTSUFX = .exe
  MAIN = 1
  PIC = 
 endif
#not 32 bit windows.
else
 ODBC = odbc 
 ifeq (${as.shared},1)
  SHARED = -shared 
  OUTSUFX = .so
  MAIN = 0
  PIC = -fPIC
 else
  SHARED =
  OUTSUFX =
  MAIN = 1
  PIC = 
 endif
endif

export FC = gfortran
export CC = gcc

ifdef sourceFileList
 ifndef sourceList
  export sourceFileList
  export sourceList = $(shell cat $(sourceFileList))
  export includes = $(notdir $(filter %.F77 %.INC %.FOR %.inc,$(sourceList))) 
  export src1 = $(notdir $(filter %f,$(sourceList))) 
  ifeq (${MAIN},0) 
   export source = $(filter-out main.f,$(src1))
  else
   export source = $(src1)
  endif
  export object = $(patsubst %.f,%.o,$(source))
 endif
endif

clean :
	rm -frv *_buildDir ../dbs/obj/fvsSQL.o libfvsSQL.so \
	   ../fire/fofem/obj/*.o libfofem.so

ifndef sourceFileList

FVSiec : FVSiec_sourceList.txt libfvsSQL.so libfofem.so $(shell cat FVSiec_sourceList.txt)
	@echo buildDir is $@_buildDir
	mkdir -pv $@_buildDir
	cp -p `cat FVSiec_sourceList.txt` $@_buildDir
	$(MAKE) --file=../newmakefile --directory=$@_buildDir buildDir=$@_buildDir \
                 sourceFileList=../$@_sourceList.txt $@.prg

FVSpnc : FVSpnc_sourceList.txt libfvsSQL.so libfofem.so $(shell cat FVSpnc_sourceList.txt)
	@echo buildDir is $@_buildDir
	mkdir -pv $@_buildDir
	cp -p `cat FVSpnc_sourceList.txt` $@_buildDir
	$(MAKE) --file=../newmakefile --directory=$@_buildDir buildDir=$@_buildDir \
                 sourceFileList=../$@_sourceList.txt $@.prg 

libfofem.so : ../fire/fofem/src/*
	${MAKE} --directory=../fire/fofem/obj --file=makefile fofem
	$(CC) $(addprefix ../fire/fofem/obj/,bur_bov.o bur_brn.o fm_fofem.o fof_bcm.o \
          fof_ci.o fof_cm.o fof_co.o fof_duf.o fof_hsf.o fof_lem.o \
          fof_mrt.o fof_sd.o fof_se.o fof_sgv.o fof_sh.o fof_sha.o \
          fof_soi.o fof_unix.o fof_util.o) -shared -o $@ 

libfvsSQL.so : ../dbs/src/fvsSQL.c 
	$(CC) $< -shared ${PIC} -l $(ODBC) -o $@ 

endif

.PRECIOUS : $(object) 

%.prg : $(object)
	$(FC) $(SHARED) -o $(basename ../$@)${OUTSUFX} ../libfvsSQL.so ../libfofem.so $(object)

%.o : %.f $(includes)
	$(FC) $(FFLAGS) -c -o $@ $<


