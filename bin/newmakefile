FC     = gfortran

ifdef sourceFileList
 ifndef sourceList
  export sourceFileList
  export sourceList = $(shell cat $(sourceFileList))
  export includes = $(notdir $(filter %.F77 %.INC %.FOR %.inc,$(sourceList))) 
  export source = $(notdir $(filter %f,$(sourceList))) 
  export object = $(patsubst %.f,%.o,$(source))
 endif
endif

clean :
	rm -frv *_buildDir ../dbs/obj/fvsSQL.o libfvsSQL.so \
	   ../fire/fofem/obj/*.o libfofem.so

ifndef sourceFileList

FVSiec : FVSiec_sourceList.txt libfvsSQL.so libfofem.so $(shell cat FVSiec_sourceList.txt)
	rm -fv $@.prg
	@echo buildDir is $@_buildDir
	mkdir -pv $@_buildDir
	cp -p `cat FVSiec_sourceList.txt` $@_buildDir
	$(MAKE) --no-builtin-rules --file=../newmakefile --directory=$@_buildDir buildDir=$@_buildDir \
                 sourceFileList=../$@_sourceList.txt $@.prg

libfofem.so : ../fire/fofem/src/*
	${MAKE} --directory=../fire/fofem/obj --file=makefile fofem
	$(CC) $(addprefix ../fire/fofem/obj/,bur_bov.o bur_brn.o fm_fofem.o fof_bcm.o \
          fof_ci.o fof_cm.o fof_co.o fof_duf.o fof_hsf.o fof_lem.o \
          fof_mrt.o fof_sd.o fof_se.o fof_sgv.o fof_sh.o fof_sha.o \
          fof_soi.o fof_unix.o fof_util.o) -shared -o $@ 

libfvsSQL.so : ../dbs/src/fvsSQL.c 
	$(CC) $< -shared ${PIC} -l odbc32 -o $@ 

endif

.PRECIOUS : $(object) $(includes)

%.prg : $(object)
	$(FC) -static -o ../$@ ../libfvsSQL.so ../libfofem.so $(object)

%.o : %.f $(includes)
	$(FC) $(FFLAGS) -c -o $@ $<


