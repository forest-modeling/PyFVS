# PyFVS Build Notes

PyFVS now builds using Meson.

Adapted from the SciPy Windows CI builds on [GitHub](https://github.com/scipy/scipy/blob/main/.github/workflows/windows.yml)

Setup on Windows
----------------

Install [RTools 4.0](https://cran.r-project.org/bin/windows/Rtools/rtools40.html)

Add the compiler to the PATH variable
    > set path=c:\rtools40\mingw64\bin;%PATH%

Create the conda environment (or pyenv/pip equivalent)
    > conda create -c conda-forge -n=pyfvs310 python=3.10 numpy pandas openpyxl meson=0.64 ninja click openpyxl

NOTE: meson=1.0.0 has a bug in LINK_ARGS with a misplaced reference to "msvcrt"

NOTE: Use of distutils for development, packaging, and distribution, Python packaging is moving to Meson.

Development
-----------

Create environment and install dependencies
Use **meson-python** for development.
As of meson-python >= 0.13.0.rc0 editable installations are available

Install development (editable) mode

    > python -m pip install --no-build-isolation -e .

To see verbose build progress and output

    > python -m pip install --no-build-isolation -v -e . --config-settings editable-verbose=true

NOTE: In editable mode meson-python calls meson/ninja each time pyfvs is imported

Test
----

    > pushd ~

Build Wheels
------------

    > python -m pip wheel --no-build-isolation -v -w dist --config-settings builddir=build_py310 .

Build
-----



    #> python setup.py develop --no-deps -- -DFVS_VARIANTS=pn,wc
    #> meson setup build_py310 --prefix=%CD%\build_py310\Lib\site-packages
    #> ninja -C build_py310
    #> meson install -C build_py310

Test
----
    > cd build_py310
    > meson install
    > set PYTHONPATH=%CD%\build_py310\Lib\site-packages
    > python -m pyfvs run-tests

Folders
-------
    open-fvs: Source code from the Open-FVS project
    build_fvs: CMake scripts to build open-fvs
    cmake: Scikit-Build CMake scripts
    pyfvs: PyFVS package root
    api: Fortran modules extending the FVS API
        gen: ** Autogenerated F90 module files for improved F2PY interface

Build On WSL2 Ubuntu 12
-----------------------

    > conda create -c conda-forge -n=pyfvs310 python=3.10 numpy ninja
    > meson setup build_wsl && cd build_wsl
    > meson compile
